<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Lista de Usuários</title>
    <link rel="stylesheet" href="/css/lista_usuarios.css">
</head>
<body>
    <nav id="navbar"></nav>

    <h2>Gerenciamento de Usuários</h2>

    <div class="user-feed">
        <div id="userFeed" class="user-feed">
            <!-- Cards de usuários serão inseridos aqui via JavaScript -->
        </div>
    </div>

    <script>
        // Verificar se o usuário está logado
         const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
            }

        // Carregar navbar
        fetch("../assets/components/navbar.html")
            .then(r => r.text())
            .then(html => {
                document.getElementById("navbar").innerHTML = html;
            });

        async function carregarUsuarios() {
        const response = await fetch("/usuarios", {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        const usuarios = await response.json();

        const feed = document.getElementById("userFeed");
        feed.innerHTML = "";

        usuarios.forEach(user => {

            // 1️⃣ Criar card
            const card = document.createElement("div");
            card.className = "user-card";

            // 2️⃣ Criar imagem
            const img = document.createElement("img");

            // 3️⃣ Se existir foto no banco
            if (user.foto) {
            img.src = user.foto;
            } else {
            img.src = "/foto/default.png"; // imagem padrão
            }

            img.alt = "Foto do usuário";

            img.onerror = () => {
            img.src = "/foto/default.png";
            };

            // 4️⃣ Criar container da foto
            const fotoDiv = document.createElement("div");
            fotoDiv.className = "user-foto";
            fotoDiv.appendChild(img);

            // 5️⃣ Header
            const header = document.createElement("div");
            header.className = "card-header";

            header.innerHTML = `
            <div class="user-name">${user.nome}</div>
            <span class="status-badge">${user.status || "Inativo"}</span>
            `;

            header.prepend(fotoDiv);

            // 6️⃣ Corpo
            const info = document.createElement("div");
            info.className = "user-info-grid";
            info.innerHTML = `
            <div class="info-item"><strong>Email</strong> ${user.gmail}</div>
            <div class="info-item"><strong>Nascimento</strong> ${formatarData(user.data_nascimento)}</div>
            <div class="info-item"><strong>Telefone</strong> ${user.telefone}</div>
            <div class="info-item"><strong>Peso</strong> ${user.peso} kg</div>
            <div class="info-item"><strong>Altura</strong> ${user.altura} m</div>
            `;

            // 7️⃣ Ações
            const actions = document.createElement("div");
            actions.className = "card-actions";
            actions.innerHTML = `
            <button class="btn btn-ativar" onclick="alterarStatus(${user.idusuario}, 'Pago')">
                Pago
            </button>
            <button class="btn btn-desativar" onclick="alterarStatus(${user.idusuario}, 'Não Pago')">
                Não Pago
            </button>
            `;

            // 8️⃣ Montar card
            card.appendChild(header);
            card.appendChild(info);
            card.appendChild(actions);

            feed.appendChild(card);
        });
        }
        function formatarData(dataStr) {
        if (!dataStr) return "";
        const data = new Date(dataStr);
        return data.toLocaleDateString("pt-BR");
        }

        async function alterarStatus(idusuario, status) {
            try{
                const response = await fetch(`/usuarios/${idusuario}/status`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    status: status
                })
                });

                if (!response.ok) {
                throw new Error("Erro ao atualizar status");
                }

                // atualiza a lista depois de mudar o status
                carregarUsuarios();

            }catch(error){
               console.error(error);
                alert("Erro ao alterar status do usuário");
            }
        }
        carregarUsuarios();

    </script>

</body>
</html>