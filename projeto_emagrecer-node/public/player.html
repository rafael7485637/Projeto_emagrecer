<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Vídeo</title>
  <link rel="stylesheet" href="../assets/css/player.css">
</head>
<body>
    <nav id="navbar"></nav>

<h1 id="titulo"></h1>

<div id="player"> 
   
</div>

<p id="descricao"></p>

<script>
   const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "/login";
  }

  // Carregar navbar
  fetch("../assets/components/navbar.html")
    .then(r => r.text())
    .then(html => {
      document.getElementById("navbar").innerHTML = html;
    });

  // Pega o ID da URL
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  // Registrar visualização
  async function registrarVisualizacao() {
    try {
      await fetch("/registrar-visualizacao", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ idvideo: id })
      });
    } catch (err) {
      console.error("Erro ao registrar visualização", err);
    }
  }

  async function carregarVideo() {
    const resposta = await fetch(`/video/${id}`, {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    const video = await resposta.json();

    document.getElementById("titulo").textContent = video.titulo;
    document.getElementById("descricao").textContent = video.descricao;

    const player = document.getElementById("player");

    // Regex do YouTube
    const youtubeRegex =
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;

    const match = video.link.match(youtubeRegex);

    if (match) {
      const videoId = match[1];

      player.innerHTML = `
        <iframe
          width="560"
          height="315"
          src="https://www.youtube.com/embed/${videoId}"
          frameborder="0"
          allowfullscreen>
        </iframe>
      `;

      // Evita contar várias vezes no F5
      const chaveView = `view_video_${id}`;
      if (!sessionStorage.getItem(chaveView)) {
        registrarVisualizacao();
        sessionStorage.setItem(chaveView, "true");
      }
    } else {
      player.innerHTML = "<p>Vídeo inválido</p>";
    }
  }

  carregarVideo();
</script>

</body>
</html>
